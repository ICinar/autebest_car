TOP = ..

include ../rules.mk
include ../rules-$(FOOBAR_RULESET).mk
include ../kernel/arch/$(ARCH)/$(SUBARCH)-$(FOOBAR_RULESET).mk

vpath %.c .
vpath %.S .

INCLUDES = -nostdinc -I../kernel/include -I../kernel/arch/$(ARCH)/include -Iinclude -I.
CFLAGS += -W -Wall -Wshadow -Wpointer-arith -Wcast-qual \
          -Wmissing-prototypes -Wstrict-prototypes \
          -fno-strict-aliasing \
          -fno-common \
          -Werror \
          -D__LIBAPEX \
          $(INCLUDES) \
          $(ARCH_USER_CFLAGS)
AFLAGS += $(INCLUDES) \
          $(ARCH_USER_AFLAGS)


# Debug settings
ifeq ("$(DEBUG)", "no")
CFLAGS += -DNDEBUG $(ARCH_CFLAGS_NDEBUG)
AFLAGS += -DNDEBUG
else
CFLAGS += -g $(ARCH_CFLAGS_DEBUG)
AFLAGS +=
endif

# libposix modules
MODS = crt0_$(ARCH) cond crit mutex __posix_init pthread_attr pthread pthread_condattr pthread_cond pthread_mutexattr pthread_mutex task wq
OBJS = $(addprefix .,$(addsuffix .o,$(MODS))) .libposix_buildid.o
DEPS = $(addprefix .,$(addsuffix .d,$(MODS)))

.PHONY: all clean distclean .FORCE

all: libposix.a

libposix.a: $(OBJS)
	@echo "  AR    $@"
	$(Q)$(AR) cr $@ $^

# autogenerated files
libposix_buildid.c: $(filter-out .libposix_buildid.o, $(OBJS))
	@echo "  GEN   $@"
	$(Q)echo "/* libposix_buildid.c */" >$@
	$(Q)echo "/* GENERATED BY MAKEFILE -- DO NOT EDIT */" >>$@
	$(Q)echo "const char __libposix_buildid[] = \"$(BUILDID)\";" >>$@

clean:
	$(Q)rm -f $(OBJS) libposix_buildid.c libposix.a

distclean: clean
	$(Q)rm -f $(DEPS)

# pull in dependencies
ifeq ("$(filter $(MAKECMDGOALS), clean distclean)", "")
-include $(DEPS)
endif
