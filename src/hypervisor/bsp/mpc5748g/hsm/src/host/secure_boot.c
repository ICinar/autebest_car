/**
* \file hsm_secure_boot.c
*
* \brief
*
* \details
*
* \version
*
* \author easycore GmbH, 91058 Erlangen, Germany
*
* \par  License
* Customer: @@LicenseCustomer@@,
* License type: @@LicenseType@@,
* Licensed for project: @@LicenseProject@@.

* Copyright 2016 easycore GmbH, All rights exclusively reserved for easycore GmbH,
* unless expressly agreed to otherwise.
*/
/*==================[inclusions]==================================================================*/
#include <secure_boot.h>
#include <sha2_256.h>
#include <string.h>
#include <board_stuff.h>

/*==================[macros]======================================================================*/

/*==================[type definitions]============================================================*/

/*==================[internal function declarations]==============================================*/

/*==================[external function declarations]==============================================*/

/*==================[external constants]==========================================================*/

/*==================[internal constants]==========================================================*/

/*==================[external data]===============================================================*/
const SecureBootTable secure_boot_table = {
      { "\x8e\x52\x05\x39\x4e\x57\xa6\x63\x94\x98\x09\x88\x0d\x9e\xc6\xaa\x41\xdb\xeb\xeb\x62\xbf\x9b\xcc\xc5\x0d\xe8\xba\x93\x03\x10\x53\x4e\x53\x38\x05\x1f\x01\x29\xff\xda\xf1\x9e\xc7\x81\xd5\x6c\x66\xc0\x6d\x52\x25\x43\x5a\x65\xfa\x5a\x32\xc3\x49\xdf\x1e\xf2\x9c\x17\xde\x9b\xc4\xaf\xe2\xc2\xc6\x22\x2e\xd1\x9e\x1c\xac\x81\x6b\xf9\x21\x18\x73\x16\x2f\xde\x9c\xc3\x5c\x51\x9e\x08\x3e\xcd\xb7\x73\x31\x1b\x32\x83\xce\x56\xd5\x72\x75\x54\x84\x51\x7d\xda\xd2\x6a\x8f\xf4\x69\xe2\x93\x64\x8d\x00\x96\x28\x93\x31\x89\xe2\x5a\xc6\x95\x4a\x08\x47\x61\xde\xb3\x1d\x8b\x8f\x8a\x41\xa9\xe7\x97\x0d\x7e\xab\xa9\x5e\x89\x95\xb9\x5e\x19\x74\x4e\x5b\x67\xb2\x6f\xf8\x75\xba\x14\x2a\x24\x89\x86\xdf\xa5\x0f\x60\xa3\xdb\xd9\x83\x3d\xce\x80\x9c\xc9\x05\xe2\xa7\x94\x31\x08\x28\xc8\x63\xa4\x0d\x01\x47\x5d\x35\xf2\x5b\xfd\xcb\x60\xd3\x65\xec\x8f\xdd\xf9\x5d\x18\x7a\xe0\xf3\x8f\x4f\x71\x40\x1c\x05\xe2\x05\x8a\x93\x30\xb7\x89\x1d\x10\xa2\xa9\xd1\x49\x6b\x49\x92\xc0\x54\x29\x52\x48\xb5\x4c\x72\x0f\x97\xff\x74\x6f\x21\xea\xad\xc6\x49\xeb\x0b\xd7\x8f" },
   3,
   {
      { 0xfc0444, 0x272, 0x7, "\x69\x14\xa5\xf0\x18\x28\xa4\xa9\x83\x80\xb6\xb7\x50\xea\xb2\x88\xa3\x34\x7c\x79\x24\x09\x4f\xf0\x6c\x3a\x62\xa6\xaf\xb9\xd3\x28" },
      { 0xfc1510, 0xe0, 0x1, "\x05\x9b\xaa\x65\x29\x92\x46\x05\x1b\x11\xa5\x16\x14\x84\x9b\x58\x1e\x9e\xd0\x3c\x68\x4d\xe6\x96\x5d\x90\x00\x2b\x7d\x73\x41\xd4" },
      { 0xfc0000, 0x444, 0x7, "\x4f\x42\x4d\xb5\x38\x96\x44\x4a\x28\x1f\x80\x55\x64\xfb\x08\x32\x2a\x22\x67\x14\x7c\x8d\x38\xd8\xf8\x0e\x11\xbb\x2f\xb1\x35\x9c" },
      { 0x0, 0x0, 0x0, "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" },
      { 0x0, 0x0, 0x0, "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" },
      { 0x0, 0x0, 0x0, "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" },
      { 0x0, 0x0, 0x0, "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" },
      { 0x0, 0x0, 0x0, "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" },
   }
};


/*==================[internal data]===============================================================*/

/*==================[internal function definitions]===============================================*/

/*==================[external function definitions]===============================================*/
void secure_boot
(
   void
)
{
   uint8 hash[32u] = { 0 };
   uint32 hash_len = 32u;
   const SecureBootTableEntry *e;
   unsigned int i = 0;

   for (i = 0u; i < secure_boot_table.count_entries; i++)
   {
      e = &(secure_boot_table.entries[i]);
      /* check if entry has to be checked during Secure Boot */
      if (e->flags & 0x2u)
      {
         /* Calculate the hash for the current memory region */
         if (EC_Crypt_SHA2_256_Hash((const uint8 *) e->start,
                                    e->size,
                                    &(hash[0u]), 
                                    &hash_len) != EC_Crypt_E_OK)
         {
            /* something went horribly wrong */
            __board_reset();
         }

         /* Compare the hash with the stored one */
         if (memcmp(&(hash[0u]), &(e->hash[0u]), 32u) != 0u)
         {
            __board_reset();
         }
      }
   }
}

/*==================[end of file]=================================================================*/       
