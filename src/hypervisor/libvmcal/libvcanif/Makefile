
TOP = ../..

include $(TOP)/rules.mk
include $(TOP)/rules-$(FOOBAR_RULESET).mk
include $(TOP)/kernel/arch/$(ARCH)/$(SUBARCH)-$(FOOBAR_RULESET).mk


INCLUDES  = -nostdinc
INCLUDES += -I$(TOP)/kernel/include
INCLUDES += -I$(TOP)/kernel/arch/$(ARCH)/include
INCLUDES += -I$(TOP)/autosar/Common
INCLUDES += -I$(TOP)/libvmcal/libvcan/include
INCLUDES += -I$(TOP)/libvmcal/common/include
INCLUDES += -Iinclude


CFLAGS += -D__LIBVMCAL
CFLAGS += -D__LIBVCANIF
CFLAGS += -DUSE_KLDD
CFLAGS += $(INCLUDES)
CFLAGS += $(ARCH_USER_CFLAGS)

AFLAGS += $(INCLUDES)
AFLAGS += $(ARCH_USER_AFLAGS)


# Debug settings
ifeq ("$(DEBUG)", "no")
CFLAGS += -DNDEBUG $(ARCH_CFLAGS_NDEBUG)
AFLAGS += -DNDEBUG
else
CFLAGS += -g $(ARCH_CFLAGS_DEBUG)
AFLAGS +=
endif

MODS += vCanIf

OBJS = $(addprefix .,$(addsuffix .o,$(MODS))) .libvcanif_buildid.o
DEPS = $(addprefix .,$(addsuffix .d,$(MODS)))

.PHONY: all clean distclean .FORCE

all: libvcanif.a

libvcanif.a: $(OBJS)
	@echo "  AR    $@"
	$(Q)$(AR) cr $@ $^

# autogenerated files
libvcanif_buildid.c: $(filter-out .libvcanif_buildid.o, $(OBJS))
	@echo "  GEN   $@"
	$(Q)echo "/* libvcanif_buildid.c */" >$@
	$(Q)echo "/* GENERATED BY MAKEFILE -- DO NOT EDIT */" >>$@
	$(Q)echo "const char __libvmcal_buildid[] = \"$(BUILDID)\";" >>$@

clean:
	$(Q)rm -f $(OBJS) libvcanif_buildid.c libvcanif.a

distclean: clean
	$(Q)rm -f $(DEPS)

# pull in dependencies
ifeq ("$(filter $(MAKECMDGOALS), clean distclean)", "")
-include $(DEPS)
endif
